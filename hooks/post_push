#!/bin/bash
export DOCKER_CLI_EXPERIMENTAL=enabled
#
echo "DOCKERFILE_PATH=${DOCKERFILE_PATH}"
echo "DOCKER_REPO=${DOCKER_REPO}"
echo "DOCKER_TAG=${DOCKER_TAG}"
echo "IMAGE_NAME=${IMAGE_NAME}"
#
# docker manifest create raymondwcs/node raymondwcs/node:latest
# docker manifest annotate raymondwcs/node raymondwcs/node:latest --os linux --arch arm64
#
echo ">>> Create manifest..."
docker manifest create ${DOCKER_REPO} "${DOCKER_REPO}:latest" "${DOCKER_REPO}:${DOCKER_TAG}"
echo ">>> Done!"

export ARCH=`echo "${DOCKERFILE_PATH}" | cut -d'.' -f2`
echo "ARCH=${ARCH}"
if [ $ARCH == "arm64" ]
then
    # DOCKER_TAG="arm64v8-latest" 
    echo ">>> Annotate..."
    # linux/arm64/v8
    docker manifest annotate ${DOCKER_REPO} "${DOCKER_REPO}:${DOCKER_TAG}" --os linux --arch ${ARCH} --variant v8
    echo ">>> Done!"
fi

docker manifest push ${DOCKER_REPO}